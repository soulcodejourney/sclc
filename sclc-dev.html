<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Code Calculator (Fixed Date Parsing)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        /* Screen Styles */
        @media (max-width: 639px) { 
            .result-grid { flex-direction: column !important; } 
            .result-grid > div { width: 100% !important; } 
            .triangle-svg { width: 225px !important; height: 181px !important; } 
            .matrix-svg { width: 140px !important; height: 105px !important; } 
            .summary-text { font-size: 1.25rem !important; } 
            .table-cell { padding: 0.25rem !important; font-size: 0.7rem !important; } 
        }
        @media (min-width: 640px) {
            .triangle-svg { width: 275px !important; height: 219px !important; }
            .matrix-svg { width: 170px !important; height: 130px !important; } 
            .container-main { max-width: 1000px !important; } 
        }
        
        body { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); }
        .header-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        .lucky-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px 12px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            line-height: 1.2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 80px;
        }
        .lucky-label { font-size: 0.6rem; text-transform: uppercase; opacity: 0.9; }
        .lucky-value { font-size: 1.1rem; letter-spacing: 1px; }
        .error-text { background-color: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }

        /* --- PRINT SETTINGS (A4 PDF) --- */
        @media print {
            @page { size: A4; margin: 5mm; }
            body { background: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print, .header-bg, #btnSaveImg, .toastify { display: none !important; }
            #app-container { padding: 0 !important; margin: 0 !important; width: 100% !important; }
            .container-main { box-shadow: none !important; max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            #resultSection { display: block !important; width: 100% !important; transform: scale(0.85); transform-origin: top center; margin-top: -20px; }
            .result-grid { display: flex !important; flex-direction: row !important; gap: 15px !important; page-break-inside: avoid; }
            .result-grid > div { width: 50% !important; box-shadow: none !important; border: 1px solid #e5e7eb; }
            .triangle-svg { width: 240px !important; height: 190px !important; }
            .matrix-svg { width: 150px !important; height: 115px !important; }
            .shadow-lg, .shadow-md { box-shadow: none !important; }
        }
    </style>
</head>
<body class="min-h-screen pb-10" oncontextmenu="return false;">

    <div class="header-bg text-white p-4 shadow-lg mb-6">
        <div class="container-main max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold">Soul Code Calculator</h1>
            <span class="bg-white/20 px-3 py-1 rounded-full text-xs font-semibold backdrop-blur-sm">Guest Mode</span>
        </div>
    </div>

    <div id="app-container" class="p-2 sm:p-4">
        
        <div class="no-print container-main max-w-4xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 relative">
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Name (‡∏ä‡∏∑‡πà‡∏≠)</label>
                <input type="text" id="clientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="Enter Name">
            </div>
            <div class="grid grid-cols-3 gap-3 sm:gap-4 mb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Date of Birth</label>
                    <input type="date" id="dob" class="w-full px-2 sm:px-3 py-2 border border-gray-300 rounded-lg text-xs sm:text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Time</label>
                    <input type="time" id="birthTime" value="00:00" class="w-full px-2 sm:px-3 py-2 border border-gray-300 rounded-lg text-xs sm:text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Predict Year</label>
                    <input type="number" id="currentYear" class="w-full px-2 sm:px-3 py-2 border border-gray-300 rounded-lg text-xs sm:text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none">
                </div>
            </div>

            <button id="btnCalc" type="button" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition shadow-md hover:shadow-lg text-sm sm:text-base">
                üßÆ SCLC Code
            </button>
        </div>

        <div id="resultSection" class="hidden container-main max-w-4xl mx-auto space-y-4">
             
             <div class="no-print flex justify-end mb-2">
                <button id="btnSaveImg" type="button" class="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-900 transition shadow text-xs sm:text-sm">
                    üñ®Ô∏è Save PDF / Print
                </button>
             </div>

             <div id="captureArea" class="bg-[#f3f4f6] p-4 rounded-xl"> 
                 
                 <div class="text-center mb-6 pb-4 border-b-2 border-gray-200">
                     <h2 id="displayName" class="text-2xl sm:text-3xl font-bold text-gray-800 tracking-wide"></h2>
                     <p id="displayDetails" class="text-sm sm:text-base text-gray-500 mt-1 font-medium"></p>
                 </div>

                 <div class="result-grid flex justify-center gap-3 sm:gap-4 mb-4">
                     <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg flex-1">
                        <div class="flex justify-between items-center mb-3 border-b border-pink-100 pb-2">
                            <h3 class="text-sm font-bold text-pink-600 uppercase tracking-wider">‚ù§Ô∏è Soul Code</h3>
                            <div id="soulBadge" class="lucky-badge bg-red-500">
                                <span class="lucky-label">LUCKY NUMBER</span>
                                <span id="soulLuckyNumber" class="lucky-value">----</span>
                            </div>
                        </div>
                        <table id="soulTable" class="w-full text-center border-collapse text-xs sm:text-sm"></table>
                    </div>

                    <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg flex-1">
                        <div class="flex justify-between items-center mb-3 border-b border-blue-100 pb-2">
                            <h3 class="text-sm font-bold text-blue-600 uppercase tracking-wider">üë§ Life Code</h3>
                            <div id="lifeBadge" class="lucky-badge bg-blue-600">
                                <span class="lucky-label">LUCKY NUMBER</span>
                                <span id="lifeLuckyNumber" class="lucky-value">----</span>
                            </div>
                        </div>
                        <table id="lifeTable" class="w-full text-center border-collapse text-xs sm:text-sm"></table>
                    </div>
                </div>

                <div class="result-grid flex justify-center gap-3 sm:gap-4 mb-4">
                    <div class="bg-pink-50 p-4 rounded-xl shadow-md flex-1 border border-pink-100">
                        <div class="flex justify-around items-center">
                            <div class="text-center"><p class="text-xs text-gray-500 mb-1 font-bold">SOUL CODE</p><p id="soulLifeCode" class="summary-text text-xl sm:text-3xl font-extrabold text-pink-600">-</p></div>
                            <div class="h-10 w-px bg-pink-200"></div>
                            <div class="text-center"><p class="text-xs text-gray-500 mb-1 font-bold">IQ</p><p id="soulIQ" class="summary-text text-xl sm:text-2xl font-bold text-pink-600">-</p></div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl shadow-md flex-1 border border-blue-100">
                        <div class="flex justify-around items-center">
                            <div class="text-center"><p class="text-xs text-gray-500 mb-1 font-bold">LIFE CODE</p><p id="lifeLifeCode" class="summary-text text-xl sm:text-3xl font-extrabold text-blue-600">-</p></div>
                            <div class="h-10 w-px bg-blue-200"></div>
                            <div class="text-center"><p class="text-xs text-gray-500 mb-1 font-bold">IQ</p><p id="lifeIQ" class="summary-text text-xl sm:text-2xl font-bold text-blue-600">-</p></div>
                        </div>
                    </div>
                </div>

                <div class="result-grid flex justify-center gap-3 sm:gap-4 mb-4">
                    <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg flex-1">
                        <h3 class="text-sm font-bold text-center mb-2 text-pink-600 uppercase">Bingo Line</h3>
                        <div class="flex justify-center gap-2 items-start">
                            <div id="soulMatrix"></div>
                            <div id="soulMatrixCount" class="text-xs pt-2"></div>
                        </div>
                    </div>
                    <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg flex-1">
                        <h3 class="text-sm font-bold text-center mb-2 text-blue-600 uppercase">Bingo Line</h3>
                        <div class="flex justify-center gap-2 items-start">
                            <div id="lifeMatrix"></div>
                            <div id="lifeMatrixCount" class="text-xs pt-2"></div>
                        </div>
                    </div>
                </div>

                <div class="result-grid flex justify-center gap-3 sm:gap-4">
                    <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg flex-1">
                        <h3 class="text-sm font-bold text-center mb-2 text-pink-600 uppercase">Triangle <span id="soulCurrentYear" class="text-gray-400"></span></h3>
                        <div class="flex flex-col items-center gap-2">
                            <div id="soulTriangle"></div>
                            <div id="soulTriangleResult" class="w-full"></div>
                        </div>
                    </div>
                    <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg flex-1">
                        <h3 class="text-sm font-bold text-center mb-2 text-blue-600 uppercase">Triangle <span id="lifeCurrentYear" class="text-gray-400"></span></h3>
                        <div class="flex flex-col items-center gap-2">
                            <div id="lifeTriangle"></div>
                            <div id="lifeTriangleResult" class="w-full"></div>
                        </div>
                    </div>
                </div>
            </div> </div>
    </div>

    <script>
        window.onload = function() {
            try {
                document.getElementById('currentYear').value = new Date().getFullYear(); 
                document.getElementById('birthTime').value = '00:00';
                
                document.getElementById('btnCalc').addEventListener('click', calculate);
                document.getElementById('btnSaveImg').addEventListener('click', printPDF);
                
                safeToast("üëã Welcome to Guest Mode");
            } catch (e) {
                console.error("Initialization Error:", e);
            }
        };

        function printPDF() { window.print(); }

        // --- SAFE DATE PARSING ---
        function parseDate(input) {
            if (!input) return null;
            // Handle YYYY-MM-DD or DD/MM/YYYY or DD-MM-YYYY
            const parts = input.split(/[-/]/);
            if (parts.length !== 3) return null;
            
            let y, m, d;
            // Assume 4 digits is year
            if (parts[0].length === 4) {
                y = parseInt(parts[0]); m = parseInt(parts[1]); d = parseInt(parts[2]);
            } else if (parts[2].length === 4) {
                d = parseInt(parts[0]); m = parseInt(parts[1]); y = parseInt(parts[2]);
            } else {
                return null;
            }
            
            if (isNaN(y) || isNaN(m) || isNaN(d)) return null;
            return { year: y, month: m, day: d };
        }

        // --- MATH UTILS ---
        function getSingleDigit(n) {
            if (isNaN(n)) return 0;
            while (n > 9) {
                 n = String(n).split('').reduce((sum, digit) => sum + parseInt(digit || 0), 0);
            }
            return n;
        }

        function sumDigits(numStr) { return String(numStr).split('').reduce((sum, d) => sum + parseInt(d || 0), 0); }
        function reduceNumber(num) { const steps = [num]; while (num >= 10) { num = String(num).split('').reduce((sum, d) => sum + parseInt(d || 0), 0); steps.push(num); } return steps; }
        function formatResult(steps) { return steps.join('/'); }
        function getDobDigits(year, month, day) { return (String(day).padStart(2,'0')+String(month).padStart(2,'0')+String(year)).split('').map(d=>parseInt(d)); }

        function calculateLuckyNumber(day, month, year, targetCode) {
            let dSum = getSingleDigit(Math.floor(day / 10) + (day % 10)); 
            let mSum = getSingleDigit(Math.floor(month / 10) + (month % 10)); 
            let A = getSingleDigit(dSum + mSum);

            let yStr = String(year).padStart(4, '0');
            let y1 = parseInt(yStr.substring(0, 2));
            let y2 = parseInt(yStr.substring(2, 4));
            let y1Sum = getSingleDigit(Math.floor(y1 / 10) + (y1 % 10));
            let y2Sum = getSingleDigit(Math.floor(y2 / 10) + (y2 % 10));
            let B = getSingleDigit(y1Sum + y2Sum);

            let C = getSingleDigit(A + B);
            let D = getSingleDigit(A + C);
            let E = getSingleDigit(B + C);
            let F = getSingleDigit(C + D);
            let G = getSingleDigit(C + E);
            let H = getSingleDigit(D + E);
            let I = getSingleDigit(E + H);
            let J = getSingleDigit(D + H);

            const L1 = G, L2 = I, L3 = F, L4 = J;
            let K1 = getSingleDigit(L1 + L2), K2 = getSingleDigit(L2 + L3), K3 = getSingleDigit(L3 + L4);
            let P1 = getSingleDigit(K1 + K2), P2 = getSingleDigit(K2 + K3);
            let P3 = getSingleDigit(P1 + P2);

            if (P3 === parseInt(targetCode)) {
                return { isValid: true, text: `${L1}${L2}${L3}${L4}` };
            } else {
                return { isValid: false, text: "ERROR" };
            }
        }

        function calculate() {
            try {
                const clientName = document.getElementById('clientName').value;
                const dobInput = document.getElementById('dob').value;
                const timeInput = document.getElementById('birthTime').value;
                const currentYear = parseInt(document.getElementById('currentYear').value);

                // --- FIXED: Robust Date Parsing ---
                const parsedDate = parseDate(dobInput);
                if (!parsedDate) { safeToast('‚ùå Invalid Date Format', "red"); return; }
                const { year, month, day } = parsedDate;

                const [hour, mins] = timeInput ? timeInput.split(':').map(Number) : [0, 0];

                let lunarYear, lunarMonth, lunarDay;
                if (typeof Solar === 'undefined') {
                    lunarYear = year; lunarMonth = month; lunarDay = day;
                } else {
                    try { 
                        const solar = Solar.fromYmd(year, month, day); 
                        const lunar = solar.getLunar(); 
                        lunarYear = lunar.getYear(); 
                        lunarMonth = Math.abs(lunar.getMonth()); 
                        lunarDay = Math.abs(lunar.getDay()); 
                    } catch (e) { 
                        lunarYear = year; lunarMonth = month; lunarDay = day; 
                    }
                }

                const soul = calculateCode(year, month, day, hour, mins);
                const soulMonthDateSum = sumDigits(String(day).padStart(2, '0')) + sumDigits(String(month).padStart(2, '0'));
                const soulSequence = createSequence(soul.startNum);
                const soulYearResults = calculateYearResults(soulMonthDateSum, currentYear);
                const soulIQ = calculateIQ(soul.dateResult, year, month, day);
                const soulCounts = countDigits(year, month, day, soul.dateResult);

                const life = calculateCode(lunarYear, lunarMonth, lunarDay, hour, mins);
                const lifeMonthDateSum = sumDigits(String(lunarDay).padStart(2, '0')) + sumDigits(String(lunarMonth).padStart(2, '0'));
                const lifeSequence = createSequence(life.startNum);
                const lifeYearResults = calculateYearResults(lifeMonthDateSum, currentYear);
                const lifeIQ = calculateIQ(life.dateResult, lunarYear, lunarMonth, lunarDay);
                const lifeCounts = countDigits(lunarYear, lunarMonth, lunarDay, life.dateResult);

                const soulLucky = calculateLuckyNumber(day, month, year, soul.startNum);
                const lifeLucky = calculateLuckyNumber(lunarDay, lunarMonth, lunarYear, life.startNum);

                document.getElementById('displayName').textContent = clientName || "Guest Analysis";
                document.getElementById('displayDetails').textContent = `DOB: ${day}/${month}/${year} | Time: ${timeInput} | Prediction Year: ${currentYear}`;

                document.getElementById('soulTable').innerHTML = generateTable(year, month, day, hour, mins, soul, 'border-pink-200', 'bg-pink-100', 'text-pink-600');
                document.getElementById('lifeTable').innerHTML = generateTable(lunarYear, lunarMonth, lunarDay, hour, mins, life, 'border-blue-200', 'bg-blue-100', 'text-blue-600');
                
                updateLuckyBadge('soulBadge', 'soulLuckyNumber', soulLucky, 'bg-red-500');
                updateLuckyBadge('lifeBadge', 'lifeLuckyNumber', lifeLucky, 'bg-blue-600');

                document.getElementById('soulLifeCode').textContent = soul.dateResult;
                document.getElementById('soulIQ').innerHTML = soulIQ.num + '<br><span class="text-xs font-normal text-gray-500">(' + soulIQ.label + ')</span>';
                document.getElementById('lifeLifeCode').textContent = life.dateResult;
                document.getElementById('lifeIQ').innerHTML = lifeIQ.num + '<br><span class="text-xs font-normal text-gray-500">(' + lifeIQ.label + ')</span>';
                
                document.getElementById('soulMatrix').innerHTML = generateMatrixSVG(soulCounts, '#db2777'); 
                document.getElementById('soulMatrixCount').innerHTML = generateCountSummary(soulCounts, 'text-pink-600');
                document.getElementById('lifeMatrix').innerHTML = generateMatrixSVG(lifeCounts, '#2563eb'); 
                document.getElementById('lifeMatrixCount').innerHTML = generateCountSummary(lifeCounts, 'text-blue-600');
                
                document.getElementById('soulCurrentYear').textContent = '(' + currentYear + ')';
                document.getElementById('lifeCurrentYear').textContent = '(' + currentYear + ')';
                document.getElementById('soulTriangle').innerHTML = generateTriangleSVG(soulSequence, soulYearResults, '#fce4ec', '#db2777', '#db2777');
                document.getElementById('soulTriangleResult').innerHTML = generateTriangleResultSummary(soulYearResults, currentYear, 'bg-pink-50', 'text-pink-600', 'border-pink-200');
                document.getElementById('lifeTriangle').innerHTML = generateTriangleSVG(lifeSequence, lifeYearResults, '#dbeafe', '#2563eb', '#2563eb');
                document.getElementById('lifeTriangleResult').innerHTML = generateTriangleResultSummary(lifeYearResults, currentYear, 'bg-blue-50', 'text-blue-600', 'border-blue-200');
                
                document.getElementById('resultSection').classList.remove('hidden');
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                console.error("Calculation Error:", err);
                safeToast("‚ùå An error occurred during calculation", "red");
            }
        }

        function updateLuckyBadge(badgeId, textId, luckyData, defaultColorClass) {
            const badge = document.getElementById(badgeId);
            const text = document.getElementById(textId);
            text.textContent = luckyData.text;
            badge.className = "lucky-badge";
            if (luckyData.isValid) { badge.classList.add(defaultColorClass); } else { badge.classList.add("error-text"); }
        }

        function extractIqDigits(lifeCode) { 
            const parts = lifeCode.split('/'); 
            if (parts.length === 2) { 
                const f = parts[0]; const l = parseInt(parts[1]); 
                if (f.length === 1) return [parseInt(f), parseInt(f), l]; 
                return [parseInt(f[0]), parseInt(f[1]), l]; 
            } 
            if (parts.length === 3) return [parseInt(parts[0][0]), parseInt(parts[0][1]), parseInt(parts[2])]; 
            return [parseInt(parts[0]), parseInt(parts[0]), parseInt(parts[0])]; 
        }

        function calculateIQ(lc, y, m, d) { 
            const [a1, a2, a3] = extractIqDigits(lc); 
            const dd = getDobDigits(y, m, d); 
            const hasA1 = dd.includes(a1); const hasA2 = dd.includes(a2); const hasA3 = dd.includes(a3);
            if (!hasA1 && !hasA2 && !hasA3) return {num: 1, label: 'Parent'}; 
            if (!hasA1 && hasA2  && !hasA3) return {num: 2, label: 'Teacher'};      
            if (hasA1  && !hasA2 && !hasA3) return {num: 2, label: 'Teacher'};      
            if (hasA1  && hasA2  && !hasA3) return {num: 3, label: 'Friend'};    
            if (!hasA1 && !hasA2 && hasA3)  return {num: 4, label: 'Partner'}; 
            if (!hasA1 && hasA2  && hasA3)  return {num: 5, label: 'Guru'};      
            if (hasA1  && !hasA2 && hasA3)  return {num: 5, label: 'Guru'};      
            if (hasA1  && hasA2  && hasA3)  return {num: 6, label: 'Self'};      
            return {num: 1, label: 'Parent'}; 
        }

        function calculateCode(y,m,d,h,mi) { 
            let ys=sumDigits(y), yr=formatResult(reduceNumber(ys)), ps=ys; 
            let ms=ps+sumDigits(String(m).padStart(2,'0')), mr=formatResult(reduceNumber(ms)); ps=ms; 
            let ds=ps+sumDigits(String(d).padStart(2,'0')), dst=reduceNumber(ds), dr=formatResult(dst), sn=dst[dst.length-1]; ps=ds; 
            let hr='-',mir='-'; 
            if(h!==0||mi!==0){ let hs=ps+sumDigits(String(h).padStart(2,'0')); hr=formatResult(reduceNumber(hs)); ps=hs; let mis=ps+sumDigits(String(mi).padStart(2,'0')); mir=formatResult(reduceNumber(mis)); } 
            return {yearResult:yr,monthResult:mr,dateResult:dr,hourResult:hr,minsResult:mir,startNum:sn}; 
        }

        function countDigits(y,m,d,lc) { 
            let s=String(y)+String(m).padStart(2,'0')+String(d).padStart(2,'0'); const p=lc.split('/'); s+=(p.length===3?p[0]+p[2]:lc.replace(/\//g,'')); 
            const c={}; for(let i=0;i<=9;i++)c[i]=0; for(const x of s) { const n = parseInt(x); if (!isNaN(n)) c[n]++; } return c; 
        }

        function generateCountSummary(c,tc) { 
            let h='<div class="grid grid-cols-2 gap-x-3 gap-y-0.5 text-xs">'; const l=[1,2,3,4,5],r=[6,7,8,9,0]; 
            for(let i=0;i<5;i++){ h+=`<div class="${c[l[i]]>0?'':'opacity-30'}"><span class="font-medium text-gray-500">${l[i]}</span> : <span class="${tc} font-bold">${c[l[i]]||'-'}</span></div>`; h+=`<div class="${c[r[i]]>0?'':'opacity-30'}"><span class="font-medium text-gray-500">${r[i]}</span> : <span class="${tc} font-bold">${c[r[i]]||'-'}</span></div>`; } return h+'</div>'; 
        }

        function generateMatrixSVG(c, sc) { 
            const pos = {1:{x:50,y:50},2:{x:50,y:130},3:{x:50,y:210},4:{x:130,y:50},5:{x:130,y:130},6:{x:130,y:210},7:{x:210,y:50},8:{x:210,y:130},9:{x:210,y:210},0:{x:290,y:210}}; 
            const rad = {1:[18],2:[15,22],3:[12,18,24],4:[10,15,20,25],5:[8,13,18,23,28]};
            const lin = [
                {n:[1,2,3],p:[[50,50],[50,210]]}, {n:[4,5,6],p:[[130,50],[130,210]]}, {n:[7,8,9],p:[[210,50],[210,210]]},
                {n:[1,4,7],p:[[50,50],[210,50]]}, {n:[2,5,8],p:[[50,130],[210,130]]}, {n:[3,6,9],p:[[50,210],[210,210]]},
                {n:[1,5,9],p:[[50,50],[210,210]]}, {n:[3,5,7],p:[[50,210],[210,50]]}, {n:[2,4],p:[[50,130],[130,50]]},
                {n:[2,6],p:[[50,130],[130,210]]}, {n:[4,8],p:[[130,50],[210,130]]}, {n:[6,8],p:[[130,210],[210,130]]}
            ]; 
            
            let s = `<svg xmlns="http://www.w3.org/2000/svg" class="matrix-svg" viewBox="0 0 340 260">
                <rect x="10" y="10" width="240" height="240" fill="#f9fafb" stroke="#e5e7eb" rx="12"/>
                <line x1="90" y1="10" x2="90" y2="250" stroke="#e5e7eb"/>
                <line x1="170" y1="10" x2="170" y2="250" stroke="#e5e7eb"/>
                <line x1="10" y1="90" x2="250" y2="90" stroke="#e5e7eb"/>
                <line x1="10" y1="170" x2="250" y2="170" stroke="#e5e7eb"/>`; 
            
            for(const l of lin) if(l.n.every(k => (c[k] || 0) > 0)) s += `<line x1="${l.p[0][0]}" y1="${l.p[0][1]}" x2="${l.p[1][0]}" y2="${l.p[1][1]}" stroke="#374151" stroke-width="3" stroke-linecap="round"/>`; 
            
            for(let k=0; k<=9; k++) {
                const p = pos[k], cnt = Math.min(c[k] || 0, 5);
                if(cnt > 0) {
                    for(const r of rad[cnt]) s += `<circle cx="${p.x}" cy="${p.y}" r="${r}" fill="none" stroke="${sc}" stroke-width="2"/>`;
                    s += `<text x="${p.x}" y="${p.y+7}" text-anchor="middle" font-size="20" font-weight="bold" fill="#1f2937">${k}</text>`;
                } else {
                    s += `<text x="${p.x}" y="${p.y+7}" text-anchor="middle" font-size="20" fill="#d1d5db">${k}</text>`;
                }
            }
            return s + '</svg>'; 
        }

        const triPos = {
            1:{x:45,y:320,rx:45,ry1:345,ry2:361,a:'middle'}, 2:{x:60,y:233,rx:40,ry1:225,ry2:241,a:'end'},
            3:{x:95,y:148,rx:75,ry1:140,ry2:156,a:'end'}, 4:{x:200,y:40,rx:200,ry1:0,ry2:20,a:'middle'}, 
            5:{x:305,y:148,rx:340,ry1:140,ry2:156,a:'start'}, 6:{x:340,y:233,rx:375,ry1:225,ry2:241,a:'start'},
            7:{x:340,y:320,rx:340,ry1:345,ry2:361,a:'middle'}, 8:{x:247,y:320,rx:247,ry1:345,ry2:361,a:'middle'},
            9:{x:153,y:320,rx:153,ry1:345,ry2:361,a:'middle'}
        };

        function generateTriangleSVG(seq, yRes, fc, sc, rc) { 
            let s = `<svg xmlns="http://www.w3.org/2000/svg" class="triangle-svg" viewBox="-30 -20 580 470">
                <polygon points="200,50 60,292 340,292" fill="${fc}" stroke="${sc}" stroke-width="2" stroke-linejoin="round"/>`; 
            
            for(let i=1; i<=9; i++) { 
                const n = seq[i-1], p = triPos[i], yd = yRes.find(r => r.lastDigit === n);
                const fs = (i===1||i===4||i===7) ? 24 : 20, ny = i===4 ? p.y : p.y+7; 
                s += `<text x="${p.x}" y="${ny}" text-anchor="${p.a}" font-size="${fs}" font-weight="bold" fill="#1f2937">${n}</text>`; 
                
                if(yd) { 
                    const ig = yd.isCurrent, c = ig ? '#16a34a' : rc, fw = ig ? 'bold' : 'normal'; 
                    if(ig) {
                        let rx_box = p.rx;
                        if(p.a === 'middle') rx_box = p.rx - 30;
                        else if(p.a === 'start') rx_box = p.rx - 5;
                        else if(p.a === 'end') rx_box = p.rx - 55;
                        s += `<rect x="${rx_box}" y="${p.ry1 - 15}" width="60" height="35" fill="#fef9c3" stroke="#16a34a" stroke-width="2" stroke-dasharray="4 2" rx="4" />`;
                    }
                    s += `<text x="${p.rx}" y="${p.ry1}" text-anchor="${p.a}" font-size="14" font-weight="${fw}" fill="${c}">${yd.result}</text>`; 
                    s += `<text x="${p.rx}" y="${p.ry2}" text-anchor="${p.a}" font-size="12" font-weight="${fw}" fill="${ig?'#16a34a':'#9ca3af'}">(${yd.year})</text>`; 
                } 
            } 
            return s + '</svg>'; 
        }

        function generateTriangleResultSummary(yr, cy, bg, tc, bc) { const c = yr.find(r => r.isCurrent); return c ? `<div class="${bg} border-2 ${bc} rounded-lg p-2 text-center w-full"><p class="text-xs text-gray-600">Prediction ${cy}</p><p class="text-lg font-bold ${tc}">${c.result}</p></div>` : ''; }
        function generateTable(y,m,d,h,mi,c,bc,bg,tc) { return `<thead><tr class="${bg}"><th class="table-cell border ${bc} px-1 sm:px-2 py-1 text-gray-600">Year</th><th class="table-cell border ${bc} px-1 sm:px-2 py-1 text-gray-600">Month</th><th class="table-cell border ${bc} px-1 sm:px-2 py-1 text-gray-600">Date</th><th class="table-cell border ${bc} px-1 sm:px-2 py-1 text-gray-600">Hour</th><th class="table-cell border ${bc} px-1 sm:px-2 py-1 text-gray-600">Mins</th></tr></thead><tbody><tr><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${y}</td><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${String(m).padStart(2,'0')}</td><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${String(d).padStart(2,'0')}</td><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${String(h).padStart(2,'0')}</td><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${String(mi).padStart(2,'0')}</td></tr><tr class="font-bold ${tc}"><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${c.yearResult}</td><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${c.monthResult}</td><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${c.dateResult}</td><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${c.hourResult}</td><td class="table-cell border ${bc} px-1 sm:px-2 py-1">${c.minsResult}</td></tr></tbody>`; }
        function safeToast(msg, color="green") { if (typeof Toastify !== 'undefined') { Toastify({ text: msg, duration: 3000, style: { background: color==="red"?"#ef4444":"#10b981", boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.1)" }, gravity: "top", position: "center" }).showToast(); } else { console.log(msg); } }
        function createSequence(s) { const q=[]; let n=s; for(let i=0;i<9;i++){ q.push(n); n=n===9?1:n+1; } return q; }
        function calculateYearResults(mds, cy) { const r=[]; for(let i=-1;i<=7;i++){ const yr=cy+i,ys=sumDigits(yr),tot=mds+ys,st=reduceNumber(tot); r.push({year:yr,result:formatResult(st),lastDigit:st[st.length-1],isCurrent:i===0}); } return r; }
    </script>
</body>
</html>